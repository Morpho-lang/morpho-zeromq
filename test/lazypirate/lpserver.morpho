
import zeromq 

print "Starting server..."

var server_endpoint = "tcp://127.0.0.1:5555"

var server = ZeroMQReply(server_endpoint) 

for (i in 1..6) {
    var req = server.receive()
    var seq = Int(req.split(" ")[1])
    print "Server received request: ${req}"

    var event = random()
    if (i>3) { 
        print event 
        if (event<0.2) {
            print "Simulating server overload"
            for (k in 1...100000000) { sin(0.1) } 
        } else if (event<0.4) {
            print "Simulating data corruption"
            seq-=1
        } else if (event<0.6) {
            print "Simulating a crash"
            break 
        }
    }

    server.send("World ${seq}") 
}

print "Ending server"